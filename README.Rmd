```{r setup,include=FALSE}
# set the knitr options ... for everyone!
# if you unset this, then vignette build bonks. oh, joy.
#opts_knit$set(progress=TRUE)
opts_knit$set(eval.after='fig.cap')
# for a package vignette, you do want to echo.
# opts_chunk$set(echo=FALSE,warning=FALSE,message=FALSE)
opts_chunk$set(warning=FALSE,message=FALSE)
#opts_chunk$set(results="asis")
opts_chunk$set(cache=TRUE,cache.path="cache/")

#opts_chunk$set(fig.path="figure/",dev=c("pdf","cairo_ps"))
opts_chunk$set(fig.path="github_extra/figure/",dev=c("png"))
opts_chunk$set(fig.width=7,fig.height=6,dpi=100,out.width='700px',out.height='600px')

# doing this means that png files are made of figures;
# the savings is small, and it looks like shit:
#opts_chunk$set(fig.path="figure/",dev=c("png","pdf","cairo_ps"))
#opts_chunk$set(fig.width=4,fig.height=4)
# for figures? this is sweave-specific?
#opts_knit$set(eps=TRUE)

# this would be for figures:
#opts_chunk$set(out.width='.8\\textwidth')
# for text wrapping:
options(width=96,digits=2)
opts_chunk$set(size="small")
opts_chunk$set(tidy=TRUE,tidy.opts=list(width.cutoff=50,keep.blank.line=TRUE))
library(ggplot2)
library(BWStest)
library(dplyr)
library(moments)
library(microbenchmark)
# chicken and egg dept:
#[![CRAN](http://www.r-pkg.org/badges/version/BWStest)](http://cran.rstudio.com/package=BWStest) 
#[![Downloads](http://cranlogs.r-pkg.org/badges/BWStest?color=green)](http://www.r-pkg.org/pkg/BWStest)
#[![Total](http://cranlogs.r-pkg.org/badges/grand-total/BWStest?color=green)](http://www.r-pkg.org/pkg/BWStest)
```

# BWStest

[![Build Status](https://travis-ci.org/shabbychef/BWStest.png)](https://travis-ci.org/shabbychef/BWStest)
[![codecov.io](http://codecov.io/github/shabbychef/BWStest/coverage.svg?branch=master)](http://codecov.io/github/shabbychef/BWStest?branch=master)
![RCpp](https://img.shields.io/badge/RCpp-inside-blue.svg)

Performs the [Baumgartner-Weiß-Schindler 2-sample test](http://doai.io/10.2307/2533862) of equal probability
distributions. 

-- Steven E. Pav, shabbychef@gmail.com

## Installation

This package can be installed 
via [drat](https://github.com/eddelbuettel/drat "drat"), or
from github:

```{r install,eval=FALSE,echo=TRUE}
# via drat:
if (require(drat)) {
    drat:::add("shabbychef")
    install.packages("BWStest")
}
# get snapshot from github (may be buggy)
if (require(devtools)) {
	install_github('shabbychef/BWStest')
}
```

# Basic Usage

The front end for the hypothesis test is the function `bws_test`. At the moment, this only
supports the classical Baumgartner-Weiß-Schindler test, returning a `htest` object:

```{r basic1,eval=TRUE,echo=TRUE}
require(BWStest)
set.seed(12345)
# under the null:
x <- rnorm(200)
y <- rnorm(200)
bval <- bws_test(x,y)
show(bval)

# under the alternative:
z <- rnorm(200,mean=1)
bval <- bws_test(x,z)
show(bval)
```

## Checking the null

  _Doverai No Proverai_ (Trust, but verify.) -- Russian proverb.

Here we perform 5000 simulations of the BWS test under the null hypothesis, then
compute the CDF of the test statistic. If the code is correct, the resultant p-values
should be uniform. So I q-q plot under the uniform law:

```{r babysteps,eval=TRUE,echo=TRUE,fig.width=5,fig.height=4,out.width='500px',out.height='400px'}
require(BWStest)

# now compute a bunch under the null:
set.seed(1234)
bvals <- replicate(5000,bws_stat(rnorm(100),rnorm(100)))
# compute the approximate p-values under the null:
pvals <- bws_cdf(bvals)

require(ggplot2)
ph <- ggplot(data.frame(pv=pvals),aes(sample=pv)) + 
  stat_qq(distribution=stats::qunif)
print(ph)
```

Looks good to me!

## Under the alternative

Here we replicate figure 2A of Baumgartner _et al._. We draw two samples from the normal distribution,
both with unit standard deviation, letting _a_ be the difference in means. 
We check the empirical rejection rate at the 0.05 level for a few different tests (the two sample Cramer Von Mises test is not readily
available for modern version of R, apparently). 
As in Baumgartner, we find that the lowly t-test
is the most powerful in this case, with the BWS and Wilcoxon displaying similar power, then the KS
test the least powerful. Note that the Kolmogorov Smirnov test does not appear to have nominal
coverage under the null, probably due to the small sample size.

```{r sim_two_A,eval=TRUE,echo=TRUE}
n.sim <- 10000
avals <- seq(0,3.2,length.out=17)
alpha <- 0.05
mnsize <- 10
set.seed(1234)
simul <- sapply(avals,function(a) {
	rejs <- replicate(n.sim,{
		x <- rnorm(mnsize,mean=0)
		y <- rnorm(mnsize,mean=a)
		bws <- bws_cdf(bws_stat(x,y),lower_tail=FALSE) <= alpha
		ttv <- t.test(x,y,alternative='two.sided')$p.value <= alpha
		ksv <- ks.test(x,y,alternative='two.sided')$p.value <= alpha
		wcx <- wilcox.test(x,y,alternative='two.sided')$p.value <= alpha
		c(bws,ttv,ksv,wcx)
	})
	rejrate <- rowMeans(rejs)
	names(rejrate) <- c('BWS test','t test','Kolmogorov Smirnov test','Wilcoxon test')
	rejrate
},simplify='matrix')

Arejrates <- data.frame(t(simul))
Arejrates$a <- avals
```
```{r fig_two_A,eval=TRUE,echo=TRUE,fig.width=8.0,fig.height=4.5,out.width='700px',out.height='500px'}
library(tidyr)
plotdf <- tidyr::gather(Arejrates,'test','rejection_rate',-a)
library(ggplot2)
ph <- ggplot(plotdf,aes(x=a,y=rejection_rate,group=test,colour=test)) + 
	geom_line() + geom_point() + labs(x='a, difference in means',y='rejection rate')
print(ph)
```

Here we replicate figure 2B of Baumgartner _et al._. We draw two samples from the normal distribution,
both with zero mean, one with unit standard deviation, the other with standard deviation of _sigma_.
We compute the empirical rejection rate at the 0.05 level, dropping the t-test
since it is not relevant for this formulation.
As in Baumgartner, 
we find the BWS test is the most powerful, followed by KS test, then Wilcoxon, which is essentially
useless in this simulation.

```{r sim_two_B,eval=TRUE,echo=TRUE}
n.sim <- 10000
svals <- seq(1,45,length.out=10)
alpha <- 0.05
mnsize <- 10
set.seed(1234)
simul <- sapply(svals,function(s) {
	rejs <- replicate(n.sim,{
		x <- rnorm(mnsize,mean=0,sd=1)
		y <- rnorm(mnsize,mean=0,sd=s)
		bws <- bws_cdf(bws_stat(x,y),lower_tail=FALSE) <= alpha
		ksv <- ks.test(x,y,alternative='two.sided')$p.value <= alpha
		wcx <- wilcox.test(x,y,alternative='two.sided')$p.value <= alpha
		c(bws,ksv,wcx)
	})
	rejrate <- rowMeans(rejs)
	names(rejrate) <- c('BWS test','Kolmogorov Smirnov test','Wilcoxon test')
	rejrate
},simplify='matrix')

Brejrates <- data.frame(t(simul))
Brejrates$sigma <- svals
```
```{r fig_two_B,eval=TRUE,echo=TRUE,fig.width=8.0,fig.height=4.5,out.width='700px',out.height='500px'}
library(tidyr)
plotdf <- tidyr::gather(Brejrates,'test','rejection_rate',-sigma)
library(ggplot2)
ph <- ggplot(plotdf,aes(x=sigma,y=rejection_rate,group=test,colour=test)) + 
	geom_line() + geom_point() + labs(x='sigma, ratio of standard deviations',y='rejection rate')
print(ph)
```

Here we replicate figure 3A of Baumgartner _et al._. We draw two samples from the exponential distribution,
letting _l_ be the ratio of the rate parameters of the two populations.
We compute the empirical rejection rate at the 0.05 level.
As in Baumgartner, 
we find the BWS test is the most powerful, followed by Wilcoxon, then KS test.

```{r sim_three_A,eval=TRUE,echo=TRUE}
n.sim <- 10000
lvals <- seq(1,12)
alpha <- 0.05
mnsize <- 10
set.seed(1234)
simul <- sapply(lvals,function(l) {
	rejs <- replicate(n.sim,{
		x <- rexp(mnsize,rate=1)
		y <- rexp(mnsize,rate=l)
		bws <- bws_cdf(bws_stat(x,y),lower_tail=FALSE) <= alpha
		ksv <- ks.test(x,y,alternative='two.sided')$p.value <= alpha
		wcx <- wilcox.test(x,y,alternative='two.sided')$p.value <= alpha
		c(bws,ksv,wcx)
	})
	rejrate <- rowMeans(rejs)
	names(rejrate) <- c('BWS test','Kolmogorov Smirnov test','Wilcoxon test')
	rejrate
},simplify='matrix')

Crejrates <- data.frame(t(simul))
Crejrates$lratio <- lvals
```
```{r fig_three_A,eval=TRUE,echo=TRUE,fig.width=8.0,fig.height=4.5,out.width='700px',out.height='500px'}
library(tidyr)
plotdf <- tidyr::gather(Crejrates,'test','rejection_rate',-lratio)
library(ggplot2)
ph <- ggplot(plotdf,aes(x=lratio,y=rejection_rate,group=test,colour=test)) + 
	geom_line() + geom_point() + labs(x='l, ratio of rate parameters',y='rejection rate')
print(ph)
```

Here we replicate figure 3B of Baumgartner _et al._. We draw two samples, one from the normal distribution
with zero mean and varianced one-twelth, the other uniformly on -0.5 to 0.5. We take equal sample sizes
from these two populations, then vary the sample size, checking the
empirical rejection rate at the 0.05 level.
As in Baumgartner, 
we find the BWS test is the most powerful, followed by the KS test, and the Wilcoxon is useless. 
The power found here seems to be much higher than that found by Baumgartner, with near 100% rejection
rate for a sample size of around 600, while Baumgartner finds those kinds of rejection rates at around
a sample size of 1200. I theorize that Baumgartner _et al._ are plotting the _sum_ of the sample sizes
on the _x_ axis.

```{r sim_three_B,eval=TRUE,echo=TRUE}
n.sim <- 10000
mvals <- seq(25,1275,by=125)
alpha <- 0.05
set.seed(1234)
simul <- sapply(mvals,function(m) {
	rejs <- replicate(n.sim,{
		x <- rnorm(m,mean=0,sd=1.0/sqrt(12.0))
		y <- runif(m,min=-0.5,max=0.5)
		bws <- bws_cdf(bws_stat(x,y),lower_tail=FALSE) <= alpha
		ksv <- ks.test(x,y,alternative='two.sided')$p.value <= alpha
		wcx <- wilcox.test(x,y,alternative='two.sided')$p.value <= alpha
		c(bws,ksv,wcx)
	})
	rejrate <- rowMeans(rejs)
	names(rejrate) <- c('BWS test','Kolmogorov Smirnov test','Wilcoxon test')
	rejrate
},simplify='matrix')

Drejrates <- data.frame(t(simul))
Drejrates$ssize <- mvals
```
```{r fig_three_B,eval=TRUE,echo=TRUE,fig.width=8.0,fig.height=4.5,out.width='700px',out.height='500px'}
library(tidyr)
plotdf <- tidyr::gather(Drejrates,'test','rejection_rate',-ssize)
library(ggplot2)
ph <- ggplot(plotdf,aes(x=ssize,y=rejection_rate,group=test,colour=test)) + 
	geom_line() + geom_point() + labs(x='m=n, sample size',y='rejection rate')
print(ph)
```

## Future work

Eventually the package will support the modified tests proposed by 
[Neuhauser](http://doai.io/10.1007/BF02762032) and 
[Murakami](http://doai.io/10.1080/00949655.2010.551516).

